<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Quản trị TraceChain - Dairy Portal v6.5 (IPFS)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/abi.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .role-hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-group { 
            padding: 0.75rem; background-color: #f8fafc; border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; outline: none; transition: all 0.2s; font-size: 0.875rem; width: 100%;
        }
        .input-group:focus { 
            border-color: #3b82f6; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* Hiệu ứng ring chuẩn CSS */
}
        .section-card { 
            background-color: white; padding: 1.5rem; border-radius: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border-top-width: 6px; animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="authOverlay" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center text-white p-6 text-center">
        <div class="mb-6 bg-blue-500/10 p-6 rounded-full">
            <i class="fas fa-shield-halved text-7xl text-blue-500"></i>
        </div>
        <h2 class="text-3xl font-bold mb-4">Dairy Chain Security</h2>
        <p class="text-slate-400 mb-8 max-w-sm">Hệ thống quản trị Web3 & IPFS. Vui lòng kết nối MetaMask để tiếp tục.</p>
        <button onclick="connectAndVerify()" class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-2xl font-bold text-lg shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3 w-full max-w-[300px] mx-auto">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Logo.svg" class="w-6 h-6 object-contain" alt="MetaMask"> 
            <span>KẾT NỐI VÍ</span>
</button>
    </div>

    <div id="mainDashboard" class="max-w-6xl mx-auto py-10 px-4 space-y-6 hidden">
        <header class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl text-white shadow-lg shadow-blue-200"><i class="fas fa-link text-2xl"></i></div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 tracking-tight uppercase">TraceChain Admin v6.5</h1>
                    <p id="roleTitle" class="text-blue-600 font-bold text-[10px] uppercase tracking-widest italic">Xác minh vai trò...</p>
                </div>
            </div>
            <div id="adminBadge" class="bg-slate-100 px-4 py-2 rounded-xl text-[10px] font-mono text-slate-600 border border-slate-200 break-all max-w-[200px] md:max-w-none"></div>
        </header>

        <div id="statusBox" class="hidden p-6 rounded-3xl text-center font-mono text-xs border-2 transition-all shadow-inner"></div>

        <section id="section_admin" class="role-hidden section-card border-slate-800">
            <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-3"><i class="fas fa-user-gear"></i> QUẢN TRỊ HỆ THỐNG</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" id="setup_nongDan" class="input-group" placeholder="Ví Nông Dân (0x...)">
                <input type="text" id="setup_nhaMay" class="input-group" placeholder="Ví Nhà Máy (0x...)">
                <input type="text" id="setup_vanChuyen" class="input-group" placeholder="Ví Vận Chuyển (0x...)">
                <input type="text" id="setup_nhaPhanPhoi" class="input-group" placeholder="Ví Nhà Phân Phối (0x...)">
            </div>
            <button onclick="callSetupChain()" class="bg-slate-800 hover:bg-black text-white px-8 py-3 rounded-xl font-bold w-full transition-colors">CẤP QUYỀN TRÊN CHUỖI</button>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section id="section_farmer" class="role-hidden section-card border-green-500">
                <h2 class="text-lg font-bold text-green-700 mb-6 flex items-center gap-3"><i class="fas fa-cow"></i> NÔNG TRẠI</h2>
                <div class="space-y-4">
                    <input type="text" id="farmer_pName" class="input-group" placeholder="Tên sản phẩm">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="farmer_fName" class="input-group" placeholder="Chủ trại">
                        <input type="text" id="farmer_breed" class="input-group" placeholder="Giống bò">
                    </div>
                    <button onclick="callFarmerWeb3()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-100 transition-all">KHỞI TẠO LÔ HÀNG</button>
                </div>
            </section>

            <section id="section_transport" class="role-hidden section-card border-orange-500">
                <h2 class="text-lg font-bold text-orange-700 mb-6 flex items-center gap-3"><i class="fas fa-truck-fast"></i> VẬN CHUYỂN</h2>
                <div class="space-y-4">
                    <input type="number" id="trans_id" class="input-group" placeholder="ID sản phẩm">
                    <input type="text" id="trans_status" class="input-group" placeholder="Trạng thái (VD: Đang giao)">
                    <input type="text" id="trans_shipNum" class="input-group" placeholder="Số vận đơn">
                    <button onclick="callTransportWeb3()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-orange-100">CẬP NHẬT LỘ TRÌNH</button>
                </div>
            </section>
        </div>

        <section id="section_factory" class="role-hidden section-card border-blue-500">
            <h2 class="text-lg font-bold text-blue-700 mb-6 flex items-center gap-3">
                <i class="fas fa-industry"></i> NHÀ MÁY CHẾ BIẾN (TÍCH HỢP IPFS)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-4">
                    <input type="number" id="factory_id" class="input-group" placeholder="ID sản phẩm">
                    <input type="text" id="factory_status" class="input-group" placeholder="Trạng thái">
                    <input type="text" id="factory_type" class="input-group" placeholder="Loại sữa (Tiệt trùng/Thanh trùng)">
                </div>
                <div class="space-y-4">
                    <input type="text" id="factory_proc" class="input-group" placeholder="Chi tiết chế biến">
                    <input type="text" id="factory_batch" class="input-group" placeholder="Số lô SX">
                    <input type="text" id="factory_shelf" class="input-group" placeholder="Hạn sử dụng">
                </div>
                <div class="space-y-4">
                    <input type="text" id="factory_con" class="input-group" placeholder="Kết quả kiểm khuẩn">
                    <input type="text" id="factory_adu" class="input-group" placeholder="Kết quả tạp chất">
                    <button onclick="processFactoryWithIPFS()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                        <i class="fas fa-cloud-arrow-up"></i> LƯU IPFS & BLOCKCHAIN
                    </button>
                </div>
            </div>
        </section>

        <section id="section_distributor" class="role-hidden section-card border-purple-500">
            <h2 class="text-lg font-bold text-purple-700 mb-6 flex items-center gap-3"><i class="fas fa-store"></i> ĐIỂM BÁN PHÂN PHỐI</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="number" id="dist_id" class="input-group" placeholder="ID">
                <input type="text" id="dist_status" class="input-group" placeholder="Trạng thái nhập">
                <input type="number" id="dist_order" class="input-group" placeholder="Số đơn hàng">
                <input type="text" id="dist_billing" class="input-group" placeholder="Mã hóa đơn">
                <input type="text" id="dist_con" class="input-group" placeholder="Ghi chú kiểm định">
                <button onclick="callDistributorWeb3()" class="lg:col-span-1 bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-2xl font-bold shadow-lg">XÁC NHẬN KHO</button>
            </div>
        </section>
    </div>

    <script>
        const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIxMTMzNzBlNi0xZjczLTQwZDQtODg0ZC04ZTI0M2ZiZWJhYjIiLCJlbWFpbCI6Im1uaW5oMjVAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6ImE3MzRmM2U3Y2Y2ZWRhNDlmYjg0Iiwic2NvcGVkS2V5U2VjcmV0IjoiYmRmMjEzZWRjMzBmOTFjMjhjOTY4ZGNmZTIzMmI5ZGRhMTE5Zjg5NDE5ZDQ4ZjdhNmMzM2ZjNzQ2M2VlZDlhZiIsImV4cCI6MTgwMDMyMzgzOH0.gYOWIj-9aD240Tzt_AJ4j5lojYG5OnFL3-u_QqcNwzM"; // <--- DÁN JWT CỦA BẠN VÀO ĐÂY
        const ROLES = {
            FARMER: "0x821620D0f62a9DE83bB5fD48a09e88C451E1234A".toLowerCase(),
            FACTORY: "0x2764b4f976dee087253eaecd2cef325107d63bf9".toLowerCase(),
            TRANSPORT: "0xA139F1A08c0DAe139fED3095e4efC13B6fa2bbfF".toLowerCase(),
            DISTRIBUTOR: "0x5b5e5f43b6d8b6f54a3e79e258f57820dde13e5e".toLowerCase(),
            ADMIN: "0xc1739e6c4d8625d5c985172da6b54d27a6fcabc9".toLowerCase()
        };

        let signer, contract;

        // 2. KẾT NỐI VÍ & KIỂM TRA QUYỀN
        async function connectAndVerify() {
            if (!window.ethereum) return alert("Vui lòng cài đặt MetaMask!");
            const provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const userWallet = (await signer.getAddress()).toLowerCase();

            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('adminBadge').innerText = `Ví: ${userWallet}`;
            
            // Khởi tạo Contract (CONTRACT_ADDRESS & CONTRACT_ABI lấy từ js/abi.js)
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            const title = document.getElementById('roleTitle');
            if (userWallet === ROLES.ADMIN) {
                document.querySelectorAll('section').forEach(s => s.classList.remove('role-hidden'));
                title.innerText = "QUYỀN: TỔNG QUẢN TRỊ";
            } else {
                if (userWallet === ROLES.FARMER) { document.getElementById('section_farmer').classList.remove('role-hidden'); title.innerText = "QUYỀN: NÔNG DÂN"; }
                if (userWallet === ROLES.FACTORY) { document.getElementById('section_factory').classList.remove('role-hidden'); title.innerText = "QUYỀN: NHÀ MÁY"; }
                if (userWallet === ROLES.TRANSPORT) { document.getElementById('section_transport').classList.remove('role-hidden'); title.innerText = "QUYỀN: VẬN CHUYỂN"; }
                if (userWallet === ROLES.DISTRIBUTOR) { document.getElementById('section_distributor').classList.remove('role-hidden'); title.innerText = "QUYỀN: NHÀ PHÂN PHỐI"; }
            }
        }

        // 3. XỬ LÝ IPFS (Dùng Pinata API)
        async function uploadToIPFS(jsonData) {
            try {
                const response = await axios.post('https://api.pinata.cloud/pinning/pinJSONToIPFS', {
                    pinataContent: jsonData,
                    pinataMetadata: { name: `Batch_${jsonData.id}_${Date.now()}` }
                }, {
                    headers: { 'Authorization': `Bearer ${PINATA_JWT}` }
                });
                return response.data.IpfsHash;
            } catch (error) {
                throw new Error("Lỗi tải lên IPFS. Kiểm tra JWT của bạn.");
            }
        }

        // 4. THỰC THI GIAO DỊCH BLOCKCHAIN
        async function executeTransaction(methodName, args) {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = "p-6 rounded-3xl text-center bg-blue-50 text-blue-600 block border-blue-200 animate-pulse";
            statusBox.innerText = "Đang chờ ký giao dịch...";

            try {
                const tx = await contract[methodName](...args);
                statusBox.innerText = "Đang xác thực trên Blockchain...";
                const receipt = await tx.wait();

                statusBox.className = "p-6 rounded-3xl text-center bg-green-50 text-green-700 block border-green-200 animate-none";
                
                if (methodName === 'createProduct') {
                    const prodCount = await contract.productCount();
                    showQRCode(prodCount);
                } else {
                    statusBox.innerHTML = `<b>THÀNH CÔNG!</b><br><small class="text-[9px]">Mã Hash: ${receipt.hash}</small>`;
                }
            } catch (e) {
                statusBox.className = "p-6 rounded-3xl text-center bg-red-50 text-red-700 block border-red-200 animate-none";
                statusBox.innerText = "LỖI: " + (e.reason || e.message);
            }
        }

        // 5. LOGIC RIÊNG CHO NHÀ MÁY (KẾT HỢP IPFS)
        async function processFactoryWithIPFS() {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = "p-6 rounded-3xl text-center bg-yellow-50 text-yellow-700 block border-yellow-200 animate-pulse";
            statusBox.innerText = "1/2: Đang đẩy dữ liệu lên IPFS...";

            try {
                const data = {
                    id: document.getElementById('factory_id').value,
                    factory_details: document.getElementById('factory_proc').value,
                    quality_tests: {
                        bacterial: document.getElementById('factory_con').value,
                        adulteration: document.getElementById('factory_adu').value
                    },
                    timestamp: new Date().toLocaleString()
                };

                const ipfsHash = await uploadToIPFS(data);
                statusBox.innerText = `2/2: Đã có IPFS CID: ${ipfsHash}. Đang ký Web3...`;

                // Lưu CID này vào trường 'factory_con' hoặc một trường tùy chỉnh trên Contract
                await executeTransaction('updateByFactory', [
                    data.id,
                    document.getElementById('factory_status').value,
                    document.getElementById('factory_proc').value,
                    document.getElementById('factory_type').value,
                    document.getElementById('factory_shelf').value,
                    document.getElementById('factory_batch').value,
                    ipfsHash, // Gửi mã IPFS thay cho text kiểm khuẩn thông thường
                    document.getElementById('factory_adu').value
                ]);
            } catch (e) {
                statusBox.className = "p-6 rounded-3xl text-center bg-red-50 text-red-700 block border-red-200 animate-none";
                statusBox.innerText = e.message;
            }
        }

        // 6. CÁC HÀM TIỆN ÍCH KHÁC
        function showQRCode(id) {
            const statusBox = document.getElementById('statusBox');
            const scanUrl = `${window.location.origin}/index.html?id=${id}`;
            statusBox.innerHTML = `
                <b>KHỞI TẠO THÀNH CÔNG! (ID: ${id})</b>
                <div class="mt-4 flex flex-col items-center gap-3 bg-white p-4 rounded-2xl shadow-sm border border-green-100 mx-auto max-w-[180px]">
                    <div id="qrcode"></div>
                    <a href="${scanUrl}" target="_blank" class="text-blue-500 hover:underline text-[10px] font-bold">Xem trang truy xuất</a>
                </div>
            `;
            new QRCode(document.getElementById("qrcode"), { text: scanUrl, width: 120, height: 120 });
        }

        function callSetupChain() {
            executeTransaction('setupChain', [
                document.getElementById('setup_nongDan').value,
                document.getElementById('setup_nhaMay').value,
                document.getElementById('setup_vanChuyen').value,
                document.getElementById('setup_nhaPhanPhoi').value
            ]);
        }

        function callFarmerWeb3() {
            executeTransaction('createProduct', [
                document.getElementById('farmer_pName').value,
                document.getElementById('farmer_fName').value,
                document.getElementById('farmer_breed').value
            ]); 
        }

        function callTransportWeb3() {
            executeTransaction('updateByTransport', [
                document.getElementById('trans_id').value,
                document.getElementById('trans_status').value,
                document.getElementById('trans_shipNum').value,
                "Truck-Cold-Storage-01", "Standard-Route"
            ]);
        }

        function callDistributorWeb3() {
            executeTransaction('updateByDistributor', [
                document.getElementById('dist_id').value,
                document.getElementById('dist_status').value,
                document.getElementById('dist_order').value,
                0, // returned
                document.getElementById('dist_billing').value,
                document.getElementById('dist_con').value
            ]);
        }

        if (window.ethereum) window.ethereum.on('accountsChanged', () => window.location.reload());
    </script>
</body>
</html>